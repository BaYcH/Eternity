(function(){var c=YAHOO.util.Dom,G=YAHOO.util.Event,y=YAHOO.util.Element,s=YAHOO.util.KeyListener;var z=Alfresco.util.encodeHTML;Alfresco.ConsoleChannels=function(H){this.name="Alfresco.ConsoleChannels";Alfresco.ConsoleChannels.superclass.constructor.call(this,H);Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["button","container","datasource","datatable","paginator","json","history"],this.onComponentsLoaded,this);var J=this;ListPanelHandler=function K(){ListPanelHandler.superclass.constructor.call(this,"list")};YAHOO.extend(ListPanelHandler,Alfresco.ConsolePanelHandler,{onLoad:function I(){}});new ListPanelHandler();return this};YAHOO.extend(Alfresco.ConsoleChannels,Alfresco.ConsoleTool,{setOptions:function v(H){this.options=YAHOO.lang.merge(this.options,H);return this},isWaiting:{state:false,callback:"",reauth:false,channelId:"",set:function t(J,I,H){this.state=true;this.callback=J;this.channelId=I;if(H){this.reauth=H}},reset:function h(){this.state=false;this.callback=this.channelId="";this.reauth=false}},authWindow:null,options:{iframeComms:false,acceptMessagesFrom:""},insituEditors:[],onReady:function u(){Alfresco.ConsoleChannels.superclass.onReady.call(this);this.widgets.newChannelButton=new YAHOO.widget.Button(this.id+"-new-button",{type:"menu",menu:this.id+"-newChannel-menu",lazyloadmenu:false});G.on(this.id+"-channelTypes","click",this.onCreateChannel,this,true);G.on(this.id+"-datatable","click",this.onChannelInteraction,this,true);this.widgets.channelDataTable=new Alfresco.util.DataTable({dataSource:{url:Alfresco.constants.PROXY_URI+"api/publishing/channels",doBeforeParseData:this.bind(function(L,I){var K=[],M=I.data.publishChannels,J=I.data.statusUpdateChannels;K=M.concat(J);return({data:K})})},dataTable:{container:this.id+"-datatable",columnDefinitions:[{key:"channel",sortable:false,formatter:this.bind(this.renderCellChannel)}],config:{MSG_EMPTY:this.msg("channelAdmin.noChannels")}}});var H=this.widgets.channelDataTable.widgets.dataTable;H.subscribe("cellClickEvent",this.onChannelInteraction,this,true);H.subscribe("renderEvent",this.onRenderEvent,this,true);this.widgets.iframe=c.get(this.id+"-iframe");if(typeof(window.postMessage)==="function"){this.options.iframeComms=true}},renderCellChannel:function E(I,H,J,K){I.innerHTML=this.renderChannel(H)},renderChannel:function p(R){var N=R.getData(),Q=' rel="'+N.id+'"',H=z(this.msg("channelAdmin.editNode.tooltip",N.title)),S='<a href="#" class="channelAction delete" '+Q+' title="'+this.msg("channelAdmin.delete.tooltip")+'">'+this.msg("channelAdmin.delete")+"</a>",M='<a href="#" class="channelAction permissions" '+Q+' title="'+this.msg("channelAdmin.permissions.tooltip")+'">'+this.msg("channelAdmin.permissions")+"</a>",K='<a href="#" class="channelAction reauth" '+Q+' title="'+this.msg("channelAdmin.reauth.tooltip")+'">'+this.msg("channelAdmin.reauth")+"</a>",J="authorised",O=this.msg("channelAdmin.authorised.tooltip"),I='<a href="#" class="channelAction editNode"'+Q+' title="'+H+'"><img class="editNode" src="'+Alfresco.constants.PROXY_URI+N.channelType.icon+'/64" title="'+H+'"/></a> ',P=this.id+"-channelName-"+R.getId(),L="";if(N.authorised!==true){J="notAuthorised";O=this.msg("channelAdmin.notAuthorised.tooltip")}L+='<div class="channel '+J+'" title="'+O+'" rel="'+N.id+'">'+I+'<div class="channelName" id="'+P+'">'+z(N.name)+'</div><span class="channelActions">'+M+K+S+"</span></div>";this.insituEditors.push({context:P,params:{type:"textBox",nodeRef:N.id,name:"prop_cm_name",value:N.name,validations:[{type:Alfresco.forms.validation.nodeName,when:"keyup",message:this.msg("validation-hint.nodeName")},{type:Alfresco.forms.validation.length,args:{min:1,max:255,crop:true},when:"keyup",message:this.msg("validation-hint.length.min.max",1,255)}],title:this.msg("channelAdmin.insitu-edit.tooltip"),errorMessage:this.msg("channelAdmin.insitu-edit.failure")},callback:{fn:this.onChannelRename,scope:this,obj:N}});return L},onCreateChannel:function F(K,I){var H=G.getTarget(K);channelType=c.getAttribute(H,"rel"),newChannelURL=Alfresco.constants.PROXY_URI+"api/publishing/channels",channelName=this.newChannelName(YAHOO.lang.trim(H.innerHTML));params="?channelType="+channelType+"&channelName="+channelName;Alfresco.util.Ajax.request({url:newChannelURL+params,method:Alfresco.util.Ajax.POST,successCallback:{fn:this.onCreateChannelSuccess,scope:this},failureCallback:{fn:function J(L){Alfresco.util.PopupManager.displayMessage({text:this.msg("channelAdmin.createChannel.failure")})},scope:this}})},onCreateChannelSuccess:function e(H){this.authoriseChannel(H,false)},authoriseChannel:function q(H,W){var T=H.json.data.authoriseUrl,V=H.json.data.authCallbackUrl,K=H.json.data.channelId,Q=H.json.data.authRedirectUrl,W=W||false,Y=function O(ac,aa){var ab=Alfresco.util.parseURL(ac),Z=Alfresco.util.parseURL(aa);return(ab.protocol===Z.protocol&&ab.host===Z.host)};if(Y(Q,window.location.href)){this.authWindow=window.open(T)}else{if(Y(Q,this.options.acceptMessagesFrom)&&this.options.iframeComms){this.widgets.iframe.contentWindow.postMessage(T,"*");this.authWindow=null;var X=this,N=function L(Z){if(Z.origin===X.options.acceptMessagesFrom){window.location.hash=Z.data}};G.addListener(window,"message",N,false)}else{var S;if(!Y(Q,window.location.href)){var R=Alfresco.util.parseURL(window.location.href),U=Alfresco.util.parseURL(window.location.href),M=Alfresco.util.parseURL(Q),P=R,J,I;U.protocol=M.protocol;U.host=M.host;S=this.msg("channelAdmin.auth.failure.url",R.getDomain(),U.getDomain(),U.getUrl())}else{S=this.msg("channelAdmin.auth.failure.browser")}Alfresco.util.PopupManager.displayPrompt({text:S,noEscape:true});this.refresh()}}this.isWaiting.set(V,K,W)},newChannelName:function n(J){var M=c.getElementsByClassName("channelName","div",this.id),I=this.msg("channelAdmin.new-channel",J),N=I,L=[],H=0;for(var K=0;K<M.length;K++){L.push(M[K].innerHTML.toLowerCase())}while(Alfresco.util.arrayContains(L,N.toLowerCase())){++H;N=I+" "+H}return N},onChannelInteraction:function A(I,H){if(YAHOO.util.Selector.test(G.getTarget(I.event),"a.delete")){this.onDeleteChannel(I.event,H)}else{if(YAHOO.util.Selector.test(G.getTarget(I.event),"a.reauth")){this.onReauthChannel(I.event,H)}else{if(YAHOO.util.Selector.test(G.getTarget(I.event),"a.permissions")){this.onPermissionsClick(I.event,H)}else{if(YAHOO.util.Selector.test(G.getTarget(I.event),".editNode")){this.onEditNode(I.event,H)}}}}},onRenderEvent:function o(J,I){var H;for(i=0,j=this.insituEditors.length;i<j;i++){H=this.insituEditors[i];Alfresco.util.createInsituEditor(H.context,H.params,H.callback)}},onChannelRename:function d(I,H){this.refresh()},onDeleteChannel:function m(K,H){var J=this,I=c.getAttribute(G.getTarget(K),"rel");Alfresco.util.PopupManager.displayPrompt({title:J.msg("channelAdmin.delete.title"),text:J.msg("channelAdmin.delete.confirm"),buttons:[{text:J.msg("button.ok"),handler:function(){this.destroy();var L=Alfresco.constants.PROXY_URI+"api/publishing/channels/"+I.replace("://","/");Alfresco.util.Ajax.request({url:L,method:Alfresco.util.Ajax.DELETE,successCallback:{fn:J.onDeleteChannelSuccess,scope:J},failureCallback:{fn:function M(N){Alfresco.util.PopupManager.displayPrompt({text:J.msg("channelAdmin.delete.failure")})},scope:J}})}},{text:J.msg("button.cancel"),handler:function(){this.destroy()},isDefault:true}]})},onDeleteChannelSuccess:function a(H){Alfresco.util.PopupManager.displayMessage({text:this.msg("channelAdmin.delete.success")});this.refresh()},onReauthChannel:function l(K,I){var J=c.getAttribute(G.getTarget(K),"rel"),H=Alfresco.constants.PROXY_URI+"api/publishing/channels/"+J.replace("://","/")+"/reauthorise";Alfresco.util.Ajax.request({url:H,method:Alfresco.util.Ajax.POST,successCallback:{fn:this.onReauthSuccess,scope:this},failureCallback:{fn:function L(M){Alfresco.util.PopupManager.displayMessage({text:this.msg("channelAdmin.auth.failure")})},scope:this}})},onReauthSuccess:function f(H){this.authoriseChannel(H,true)},onPermissionsClick:function B(J,H){var I=c.getAttribute(G.getTarget(J),"rel");Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/manage-permissions/manage-permissions?nodeRef="+I+"&htmlid="+this.id,successCallback:{fn:this.onPermissionsTemplateLoaded,scope:this},failureMessage:Alfresco.util.message("channelAdmin.template.error",this.name),execScripts:true})},onPermissionsTemplateLoaded:function D(J){var H=c.get(this.id+"-managepermissions"),I=c.get(this.id+"-body"),M=Alfresco.util.ComponentManager.findFirst("Alfresco.component.ManagePermissions").options.nodeRef,K=Alfresco.constants.PROXY_URI+"slingshot/doclib/node/"+M.uri;H.innerHTML=J.serverResponse.responseText;c.addClass(I,"managePermissions");Alfresco.util.Ajax.jsonGet({url:K,successCallback:{fn:function L(O){if(O.json!==undefined){var N=O.json.item;YAHOO.Bubbling.fire("nodeDetailsAvailable",{nodeDetails:N,metadata:O.json.metadata})}},scope:this},failureMessage:"Failed to load data for permission details"});Alfresco.component.ManagePermissions.prototype._navigateForward=function(){c.removeClass(I,"managePermissions");H.innerHTML=""}},onStateChanged:function x(){var I=window.location.hash.substring(1),H=this.isWaiting.callback;if(I!==""&&this.isWaiting.state){if(I!=="complete"&&H!==""){this.onAuthCallback(I,H)}else{this.onAuthComplete()}}},onAuthCallback:function w(K,I){localUrl=Alfresco.constants.PROXY_URI+I.split(Alfresco.constants.PROXY_URI_RELATIVE)[1];var L=K.split("&");for(var J=0;J<L.length;J++){param=L[J].split("=");if(param[1]!=="undefined"){param[1]=encodeURIComponent(param[1])}L[J]=param.join("=")}K=L.join("&");Alfresco.util.Ajax.request({url:localUrl+"?"+K,successCallback:{fn:this.onAuthComplete,scope:this},failureCallback:{fn:function H(M){Alfresco.util.PopupManager.displayMessage({text:this.msg("channelAdmin.auth.failure")})},scope:this}})},onAuthComplete:function C(){if(!this.isWaiting.reauth){var H=Alfresco.util.createBalloon(this.id,{text:this.msg("channelAdmin.createChannel.success"),width:"20em"});H.show();YAHOO.lang.later(10000,this,function(){H.hide()})}this.isWaiting.reset();this.refresh()},onEditNode:function k(I,J){var O=c.getAttribute(G.getTarget(I),"rel")||c.getAttribute(c.getAncestorByTagName(G.getTarget(I),"a"),"rel");if(O){var L=this.id+"-editNode",N=new Alfresco.module.SimpleDialog(L),P=document.createElement("div");P.innerHTML="<h2>"+this.msg("channelAdmin.editNode.header")+"</h2>";c.addClass(P,"yui-g");var Q=function M(R,S){c.get(L+"-form-container_h").innerHTML=this.msg("channelAdmin.editNode.title");c.insertBefore(P,c.get(L+"-form-fields"))};N.setOptions({width:"33em",templateUrl:YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&mode={mode}&submitType={submitType}&showCancelButton=true",{itemKind:"node",itemId:O,mode:"edit",submitType:"json"}),actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:Q,scope:this},onSuccess:{fn:function H(R){this.onEditNodeFinished();Alfresco.util.PopupManager.displayMessage({text:this.msg("channelAdmin.editNode.success")})},scope:this},onFailure:{fn:function K(R){if(R){Alfresco.util.PopupManager.displayMessage({text:this.msg("channelAdmin.editNode.failure")})}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.failure")})}},scope:this}}).show()}I.preventDefault()},onEditNodeFinished:function g(){this.refresh()},refresh:function b(){var H=this.widgets.channelDataTable.widgets.dataTable;window.location.hash="";this.insituEditors=[];H.getDataSource().sendRequest("",{success:H.onDataReturnInitializeTable,scope:H})},_showPanel:function r(){this.widgets.escapeListener.enable();this.widgets.panel.show()}})})();